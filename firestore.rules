/**
 * @fileoverview Firestore Security Rules for Five Star Gym.
 *
 * Core Philosophy:
 * This ruleset enforces a strict ownership model for student data,
 * ensuring only the authenticated user (student) or authorized employees can
 * access specific information. Data for employees is secured based on their roles.
 *
 * Data Structure:
 * - /alunos/{alunoId}: Stores student data.
 * - /alunos/{alunoId}/matriculas/{matriculaId}: Stores enrollment data for a student.
 * - /alunos/{alunoId}/pagamentos/{pagamentoId}: Stores payment history for a student.
 * - /alunos/{alunoId}/treinos/{treinoId}: Stores workout plans for a student.
 * - /alunos/{alunoId}/treinos/{treinoId}/exercicios/{exercicioId}: Stores exercises within a workout plan.
 * - /planos/{planoId}: Stores a catalog of available plans.
 * - /funcionarios/{funcionarioId}: Stores employee data, including roles.
 *
 * Key Security Decisions:
 * - Aluno data is primarily accessible to the authenticated Aluno.
 * - Funcionario access is role-based and validated by checking for their existence in the /funcionarios collection.
 * - Listing of documents is allowed only when it's secure (e.g., listing one's own documents or employees listing all students).
 * - Plan data is assumed to be public.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isFuncionario() {
      // Allow if the user exists in the 'funcionarios' collection.
      return request.auth != null && exists(/databases/$(database)/documents/funcionarios/$(request.auth.uid));
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    match /alunos/{alunoId} {
      // COLLECTION-LEVEL Rules: Apply to the collection as a whole
      allow list: if isFuncionario();
      allow create: if isOwner(alunoId) || isFuncionario();

      // DOCUMENT-LEVEL Rules: Apply to specific documents
      allow get, update: if isOwner(alunoId) || isFuncionario();
      allow delete: if isFuncionario();

      match /matriculas/{matriculaId} {
        allow get, list: if isOwner(alunoId) || isFuncionario();
        allow create, update, delete: if isFuncionario();
      }

      match /pagamentos/{pagamentoId} {
        allow get, list: if isOwner(alunoId) || isFuncionario();
        allow create, update, delete: if isFuncionario();
      }

      match /treinos/{treinoId} {
        allow get, list: if isOwner(alunoId) || isFuncionario();
        allow create, update, delete: if isOwner(alunoId) || isFuncionario();

        match /exercicios/{exercicioId} {
          allow get, list: if isOwner(alunoId) || isFuncionario();
          allow create, update, delete: if isOwner(alunoId) || isFuncionario();
        }
      }
    }

    match /planos/{planoId} {
      allow get, list: if request.auth != null;
      allow create, update, delete: if isFuncionario();
    }

    match /funcionarios/{funcionarioId} {
      allow read: if request.auth != null; // Allow any authenticated user to read from funcionarios
      allow write: if isOwner(funcionarioId); // Only owner can write to their own document
    }
  }
}
