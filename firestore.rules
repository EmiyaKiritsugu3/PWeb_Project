/**
 * @fileoverview Firestore Security Rules for Five Star Gym.
 *
 * Core Philosophy:
 * This ruleset enforces a strict ownership model. Students can only access
 * their own data. Employees (`funcionarios`) have broader, but still defined,
 * access rights based on their role, which is validated by checking for their
 * existence in the /funcionarios collection.
 *
 * Data Structure:
 * - /alunos/{alunoId}: Student data.
 * - /alunos/{alunoId}/... (subcollections): Student's private data.
 * - /planos/{planoId}: Publicly readable plan catalog.
 * - /funcionarios/{funcionarioId}: Employee data and roles.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    /**
     * Checks if the requesting user is an employee.
     * Their UID must exist as a document ID in the /funcionarios collection.
     */
    function isFuncionario() {
      return request.auth != null && exists(/databases/$(database)/documents/funcionarios/$(request.auth.uid));
    }
    
    /**
     * Checks if the requesting user is the owner of a document.
     * Their UID must match the provided userId document ID.
     */
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // --- COLLECTION RULES ---

    match /alunos/{alunoId} {
      // Employees can list all students.
      allow list: if isFuncionario();
      
      // An employee can create a student record.
      // A user can create their OWN student record (e.g., on first sign-up).
      allow create: if isFuncionario() || isOwner(alunoId);

      // Only the owner (student) or an employee can get or update a student's profile.
      allow get, update: if isOwner(alunoId) || isFuncionario();
      
      // Only employees can delete student profiles.
      allow delete: if isFuncionario();

      // --- SUBCOLLECTION RULES ---

      match /matriculas/{matriculaId} {
        // Owner or employee can view enrollment history.
        allow get, list: if isOwner(alunoId) || isFuncionario();
        // Only employees can create, update, or delete enrollments.
        allow create, update, delete: if isFuncionario();
      }

      match /pagamentos/{pagamentoId} {
        // Owner or employee can view payment history.
        allow get, list: if isOwner(alunoId) || isFuncionario();
        // Only employees can manage payments.
        allow create, update, delete: if isFuncionario();
      }

      match /treinos/{treinoId} {
        // Owner or employee can read workout plans.
        allow get, list: if isOwner(alunoId) || isFuncionario();
        // Owner (creating their own plan) or an employee can create, update, or delete workouts.
        allow create, update, delete: if isOwner(alunoId) || isFuncionario();

        match /exercicios/{exercicioId} {
          // Same permissions as the parent workout plan.
          allow get, list, create, update, delete: if isOwner(alunoId) || isFuncionario();
        }
      }
    }

    match /planos/{planoId} {
      // All authenticated users can see the available plans.
      allow get, list: if request.auth != null;
      // Only employees can create, update, or delete plans from the catalog.
      allow create, update, delete: if isFuncionario();
    }

    match /funcionarios/{funcionarioId} {
      // Any authenticated user can read employee info (e.g., to see instructor names).
      allow read: if request.auth != null;
      // An employee can only write to their OWN document.
      allow write: if isOwner(funcionarioId);
    }
  }
}
