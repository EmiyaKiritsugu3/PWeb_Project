/**
 * @fileoverview Firestore Security Rules for Five Star Gym.
 *
 * Core Philosophy:
 * This ruleset enforces a strict ownership model for student data,
 * ensuring only the authenticated user (student) or authorized employees can
 * access specific information. Data for employees is secured based on their roles.
 *
 * Data Structure:
 * - /alunos/{alunoId}: Stores student data.
 * - /alunos/{alunoId}/matriculas/{matriculaId}: Stores enrollment data for a student.
 * - /alunos/{alunoId}/pagamentos/{pagamentoId}: Stores payment history for a student.
 * - /alunos/{alunoId}/treinos/{treinoId}: Stores workout plans for a student.
 * - /alunos/{alunoId}/treinos/{treinoId}/exercicios/{exercicioId}: Stores exercises within a workout plan.
 * - /planos/{planoId}: Stores a catalog of available plans.
 * - /funcionarios/{funcionarioId}: Stores employee data, including roles.
 *
 * Key Security Decisions:
 * - Aluno data is primarily accessible to the authenticated Aluno.
 * - Funcionario access is role-based and validated by checking for their existence in the /funcionarios collection.
 * - Listing of documents is allowed only when it's secure (e.g., listing one's own documents or employees listing all students).
 * - Plan data is assumed to be public.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isFuncionario() {
      // Allow if the user exists in the 'funcionarios' collection.
      return request.auth != null && exists(/databases/$(database)/documents/funcionarios/$(request.auth.uid));
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    /**
     * @description Rules for the 'alunos' collection as a whole.
     * Allows employees to list and create students.
     * @path /alunos
     */
    match /alunos {
      allow list, create: if isFuncionario();
    }

    /**
     * @description Rules for a single student document.
     * @path /alunos/{alunoId}
     */
    match /alunos/{alunoId} {
      // Rules for a specific document (reading, updating, deleting)
      allow get, update: if isOwner(alunoId) || isFuncionario();
      allow delete: if isFuncionario();

      /**
       * @description Grants access to enrollment data based on student ownership.
       * @path /alunos/{alunoId}/matriculas/{matriculaId}
       */
      match /matriculas/{matriculaId} {
        allow get, list: if isOwner(alunoId) || isFuncionario();
        allow create, update, delete: if isFuncionario();
      }

      /**
       * @description Grants access to payment data based on student ownership.
       * @path /alunos/{alunoId}/pagamentos/{pagamentoId}
       */
      match /pagamentos/{pagamentoId} {
        allow get, list: if isOwner(alunoId) || isFuncionario();
        allow create, update, delete: if isFuncionario();
      }

      /**
       * @description Grants access to workout plans based on student ownership.
       * @path /alunos/{alunoId}/treinos/{treinoId}
       */
      match /treinos/{treinoId} {
        allow get, list: if isOwner(alunoId) || isFuncionario();
        allow create, update, delete: if isOwner(alunoId) || isFuncionario();

        /**
         * @description Grants access to exercises within a workout plan based on student ownership.
         * @path /alunos/{alunoId}/treinos/{treinoId}/exercicios/{exercicioId}
         */
        match /exercicios/{exercicioId} {
          allow get, list: if isOwner(alunoId) || isFuncionario();
          allow create, update, delete: if isOwner(alunoId) || isFuncionario();
        }
      }
    }

    /**
     * @description Allows public read access to the catalog of plans. Writes are denied in this prototype.
     * @path /planos/{planoId}
     */
    match /planos/{planoId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Grants access to employee data based on their own ID.
     * @path /funcionarios/{funcionarioId}
     */
    match /funcionarios/{funcionarioId} {
      allow read: if request.auth != null; // Allow any authenticated user to read employee roles
      allow write: if isOwner(funcionarioId); // Only the employee can write to their own document
    }
  }
}
